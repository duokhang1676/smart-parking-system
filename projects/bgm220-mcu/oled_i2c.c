#include "oled_i2c.h"
#include "sl_i2cspm.h"
#include "sl_sleeptimer.h"
#include <string.h>
#include <stdio.h>

extern sl_i2cspm_t *sl_i2cspm_mikroe;

// Display buffer (128 x 64 bits = 1024 bytes)
static uint8_t oled_buffer[OLED_WIDTH * OLED_PAGES];
static uint8_t cursor_x = 0;
static uint8_t cursor_y = 0;

// Complete 5x7 font (ASCII 32-126)
static const uint8_t font_5x7[][5] = {
    {0x00, 0x00, 0x00, 0x00, 0x00}, // 32  (space)
    {0x00, 0x00, 0x5F, 0x00, 0x00}, // 33  !
    {0x00, 0x07, 0x00, 0x07, 0x00}, // 34  "
    {0x14, 0x7F, 0x14, 0x7F, 0x14}, // 35  #
    {0x24, 0x2A, 0x7F, 0x2A, 0x12}, // 36  $
    {0x23, 0x13, 0x08, 0x64, 0x62}, // 37  %
    {0x36, 0x49, 0x55, 0x22, 0x50}, // 38  &
    {0x00, 0x05, 0x03, 0x00, 0x00}, // 39  '
    {0x00, 0x1C, 0x22, 0x41, 0x00}, // 40  (
    {0x00, 0x41, 0x22, 0x1C, 0x00}, // 41  )
    {0x14, 0x08, 0x3E, 0x08, 0x14}, // 42  *
    {0x08, 0x08, 0x3E, 0x08, 0x08}, // 43  +
    {0x00, 0x50, 0x30, 0x00, 0x00}, // 44  ,
    {0x08, 0x08, 0x08, 0x08, 0x08}, // 45  -
    {0x00, 0x60, 0x60, 0x00, 0x00}, // 46  .
    {0x20, 0x10, 0x08, 0x04, 0x02}, // 47  /
    {0x3E, 0x51, 0x49, 0x45, 0x3E}, // 48  0
    {0x00, 0x42, 0x7F, 0x40, 0x00}, // 49  1
    {0x42, 0x61, 0x51, 0x49, 0x46}, // 50  2
    {0x21, 0x41, 0x45, 0x4B, 0x31}, // 51  3
    {0x18, 0x14, 0x12, 0x7F, 0x10}, // 52  4
    {0x27, 0x45, 0x45, 0x45, 0x39}, // 53  5
    {0x3C, 0x4A, 0x49, 0x49, 0x30}, // 54  6
    {0x01, 0x71, 0x09, 0x05, 0x03}, // 55  7
    {0x36, 0x49, 0x49, 0x49, 0x36}, // 56  8
    {0x06, 0x49, 0x49, 0x29, 0x1E}, // 57  9
    {0x00, 0x36, 0x36, 0x00, 0x00}, // 58  :
    {0x00, 0x56, 0x36, 0x00, 0x00}, // 59  ;
    {0x08, 0x14, 0x22, 0x41, 0x00}, // 60  <
    {0x14, 0x14, 0x14, 0x14, 0x14}, // 61  =
    {0x00, 0x41, 0x22, 0x14, 0x08}, // 62  >
    {0x02, 0x01, 0x51, 0x09, 0x06}, // 63  ?
    {0x32, 0x49, 0x79, 0x41, 0x3E}, // 64  @
    {0x7E, 0x11, 0x11, 0x11, 0x7E}, // 65  A
    {0x7F, 0x49, 0x49, 0x49, 0x36}, // 66  B
    {0x3E, 0x41, 0x41, 0x41, 0x22}, // 67  C
    {0x7F, 0x41, 0x41, 0x22, 0x1C}, // 68  D
    {0x7F, 0x49, 0x49, 0x49, 0x41}, // 69  E
    {0x7F, 0x09, 0x09, 0x09, 0x01}, // 70  F
    {0x3E, 0x41, 0x49, 0x49, 0x7A}, // 71  G
    {0x7F, 0x08, 0x08, 0x08, 0x7F}, // 72  H
    {0x00, 0x41, 0x7F, 0x41, 0x00}, // 73  I
    {0x20, 0x40, 0x41, 0x3F, 0x01}, // 74  J
    {0x7F, 0x08, 0x14, 0x22, 0x41}, // 75  K
    {0x7F, 0x40, 0x40, 0x40, 0x40}, // 76  L
    {0x7F, 0x02, 0x0C, 0x02, 0x7F}, // 77  M
    {0x7F, 0x04, 0x08, 0x10, 0x7F}, // 78  N
    {0x3E, 0x41, 0x41, 0x41, 0x3E}, // 79  O
    {0x7F, 0x09, 0x09, 0x09, 0x06}, // 80  P
    {0x3E, 0x41, 0x51, 0x21, 0x5E}, // 81  Q
    {0x7F, 0x09, 0x19, 0x29, 0x46}, // 82  R
    {0x46, 0x49, 0x49, 0x49, 0x31}, // 83  S
    {0x01, 0x01, 0x7F, 0x01, 0x01}, // 84  T
    {0x3F, 0x40, 0x40, 0x40, 0x3F}, // 85  U
    {0x1F, 0x20, 0x40, 0x20, 0x1F}, // 86  V
    {0x3F, 0x40, 0x38, 0x40, 0x3F}, // 87  W
    {0x63, 0x14, 0x08, 0x14, 0x63}, // 88  X
    {0x07, 0x08, 0x70, 0x08, 0x07}, // 89  Y
    {0x61, 0x51, 0x49, 0x45, 0x43}, // 90  Z
    {0x00, 0x7F, 0x41, 0x41, 0x00}, // 91  [
    {0x02, 0x04, 0x08, 0x10, 0x20}, // 92  (backslash)
    {0x00, 0x41, 0x41, 0x7F, 0x00}, // 93  ]
    {0x04, 0x02, 0x01, 0x02, 0x04}, // 94  ^
    {0x40, 0x40, 0x40, 0x40, 0x40}, // 95  _
    {0x00, 0x01, 0x02, 0x04, 0x00}, // 96  `
    {0x20, 0x54, 0x54, 0x54, 0x78}, // 97  a
    {0x7F, 0x48, 0x44, 0x44, 0x38}, // 98  b
    {0x38, 0x44, 0x44, 0x44, 0x20}, // 99  c
    {0x38, 0x44, 0x44, 0x48, 0x7F}, // 100 d
    {0x38, 0x54, 0x54, 0x54, 0x18}, // 101 e
    {0x08, 0x7E, 0x09, 0x01, 0x02}, // 102 f
    {0x0C, 0x52, 0x52, 0x52, 0x3E}, // 103 g
    {0x7F, 0x08, 0x04, 0x04, 0x78}, // 104 h
    {0x00, 0x44, 0x7D, 0x40, 0x00}, // 105 i
    {0x20, 0x40, 0x44, 0x3D, 0x00}, // 106 j
    {0x7F, 0x10, 0x28, 0x44, 0x00}, // 107 k
    {0x00, 0x41, 0x7F, 0x40, 0x00}, // 108 l
    {0x7C, 0x04, 0x18, 0x04, 0x78}, // 109 m
    {0x7C, 0x08, 0x04, 0x04, 0x78}, // 110 n
    {0x38, 0x44, 0x44, 0x44, 0x38}, // 111 o
    {0x7C, 0x14, 0x14, 0x14, 0x08}, // 112 p
    {0x08, 0x14, 0x14, 0x18, 0x7C}, // 113 q
    {0x7C, 0x08, 0x04, 0x04, 0x08}, // 114 r
    {0x48, 0x54, 0x54, 0x54, 0x20}, // 115 s
    {0x04, 0x3F, 0x44, 0x40, 0x20}, // 116 t
    {0x3C, 0x40, 0x40, 0x20, 0x7C}, // 117 u
    {0x1C, 0x20, 0x40, 0x20, 0x1C}, // 118 v
    {0x3C, 0x40, 0x30, 0x40, 0x3C}, // 119 w
    {0x44, 0x28, 0x10, 0x28, 0x44}, // 120 x
    {0x0C, 0x50, 0x50, 0x50, 0x3C}, // 121 y
    {0x44, 0x64, 0x54, 0x4C, 0x44}, // 122 z
    {0x00, 0x08, 0x36, 0x41, 0x00}, // 123 {
    {0x00, 0x00, 0x7F, 0x00, 0x00}, // 124 |
    {0x00, 0x41, 0x36, 0x08, 0x00}, // 125 }
    {0x10, 0x08, 0x08, 0x10, 0x08}, // 126 ~
};

/**
 * @brief Send command to OLED
 */
static bool oled_send_command(uint8_t cmd)
{
    I2C_TransferSeq_TypeDef seq;
    uint8_t tx_buf[2] = {0x00, cmd}; // Control byte (0x00) + command
    
    seq.addr = OLED_I2C_ADDR << 1;
    seq.flags = I2C_FLAG_WRITE;
    seq.buf[0].data = tx_buf;
    seq.buf[0].len = 2;
    seq.buf[1].len = 0;
    
    return (I2CSPM_Transfer(sl_i2cspm_mikroe, &seq) == i2cTransferDone);
}

/**
 * @brief Send data to OLED
 */
static bool oled_send_data(uint8_t *data, uint16_t len)
{
    I2C_TransferSeq_TypeDef seq;
    uint8_t tx_buf[len + 1];
    
    tx_buf[0] = 0x40; // Control byte for data
    memcpy(&tx_buf[1], data, len);
    
    seq.addr = OLED_I2C_ADDR << 1;
    seq.flags = I2C_FLAG_WRITE;
    seq.buf[0].data = tx_buf;
    seq.buf[0].len = len + 1;
    seq.buf[1].len = 0;
    
    return (I2CSPM_Transfer(sl_i2cspm_mikroe, &seq) == i2cTransferDone);
}

/**
 * @brief Initialize OLED display (SSD1306)
 */
bool oled_init(void)
{
    sl_sleeptimer_delay_millisecond(100);
    
    // Initialization sequence for SSD1306
    oled_send_command(OLED_CMD_DISPLAY_OFF);
    oled_send_command(0x20); // Set memory addressing mode
    oled_send_command(0x00); // Horizontal addressing mode
    oled_send_command(0xB0); // Set page start address
    oled_send_command(0xC8); // Set COM scan direction
    oled_send_command(0x00); // Set low column address
    oled_send_command(0x10); // Set high column address
    oled_send_command(0x40); // Set start line address
    oled_send_command(0x81); // Set contrast
    oled_send_command(0xFF); // Max contrast
    oled_send_command(0xA1); // Set segment remap
    oled_send_command(0xA6); // Normal display
    oled_send_command(0xA8); // Set multiplex ratio
    oled_send_command(0x3F); // 1/64 duty
    oled_send_command(0xA4); // Display follows RAM
    oled_send_command(0xD3); // Set display offset
    oled_send_command(0x00); // No offset
    oled_send_command(0xD5); // Set display clock divide
    oled_send_command(0xF0); // Suggested ratio 0xF0
    oled_send_command(0xD9); // Set pre-charge period
    oled_send_command(0x22);
    oled_send_command(0xDA); // Set COM pins
    oled_send_command(0x12);
    oled_send_command(0xDB); // Set VCOMH
    oled_send_command(0x20);
    oled_send_command(0x8D); // Enable charge pump
    oled_send_command(0x14);
    oled_send_command(OLED_CMD_DISPLAY_ON);
    
    oled_clear();
    oled_update();
    
    return true;
}

/**
 * @brief Clear display buffer
 */
void oled_clear(void)
{
    memset(oled_buffer, 0x00, sizeof(oled_buffer));
    cursor_x = 0;
    cursor_y = 0;
}

/**
 * @brief Update display with buffer content
 */
void oled_update(void)
{
    for (uint8_t page = 0; page < OLED_PAGES; page++) {
        oled_send_command(0xB0 + page); // Set page address
        oled_send_command(0x00);        // Set low column address
        oled_send_command(0x10);        // Set high column address
        
        oled_send_data(&oled_buffer[page * OLED_WIDTH], OLED_WIDTH);
    }
}

/**
 * @brief Set cursor position
 */
void oled_set_cursor(uint8_t x, uint8_t y)
{
    if (x < OLED_WIDTH && y < OLED_PAGES) {
        cursor_x = x;
        cursor_y = y;
    }
}

/**
 * @brief Write character at current cursor
 */
void oled_write_char(char c)
{
    if (c < 32 || c > 126) {
        c = 32; // Replace with space
    }
    
    uint8_t char_index = c - 32;
    uint16_t offset = cursor_y * OLED_WIDTH + cursor_x;
    
    // Draw 5x7 character
    for (uint8_t i = 0; i < 5; i++) {
        if (cursor_x < OLED_WIDTH) {
            oled_buffer[offset++] = font_5x7[char_index][i];
            cursor_x++;
        }
    }
    
    // Add space between characters
    if (cursor_x < OLED_WIDTH) {
        oled_buffer[offset] = 0x00;
        cursor_x++;
    }
}

/**
 * @brief Write string at current cursor
 */
void oled_write_string(const char *str)
{
    while (*str) {
        oled_write_char(*str++);
    }
}

/**
 * @brief Write string at specific position
 */
void oled_write_string_at(uint8_t x, uint8_t y, const char *str)
{
    oled_set_cursor(x, y);
    oled_write_string(str);
}

/**
 * @brief Turn display on
 */
void oled_display_on(void)
{
    oled_send_command(OLED_CMD_DISPLAY_ON);
}

/**
 * @brief Turn display off
 */
void oled_display_off(void)
{
    oled_send_command(OLED_CMD_DISPLAY_OFF);
}

/**
 * @brief Set contrast
 */
void oled_set_contrast(uint8_t contrast)
{
    oled_send_command(OLED_CMD_SET_CONTRAST);
    oled_send_command(contrast);
}

/**
 * @brief Fill display with pattern
 */
void oled_fill(uint8_t pattern)
{
    memset(oled_buffer, pattern, sizeof(oled_buffer));
}
